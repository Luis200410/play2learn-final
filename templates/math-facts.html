{% extends "_base_vue.html" %}

{% block title %}Math Facts{% endblock %}
{% block main %}
  <div class="container py-4">
    <div class="row">
      <div class="col-lg-8 col-md-10">
        <h1 class="mb-3">Math Facts</h1>
        <script>
    // Normalize URL to match Vue Router path (no trailing slash)
    (function () {
      if (window.location.pathname.endsWith('/math-facts/')) {
        window.history.replaceState(null, '', '/math-facts');
      }
    })();
  </script>
  <div class="mt-3">
    <ul class="nav nav-pills mb-3" id="mf-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="mf-leaderboard-tab" data-bs-toggle="pill" data-bs-target="#mf-leaderboard" type="button" role="tab">Leaderboard</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="mf-history-tab" data-bs-toggle="pill" data-bs-target="#mf-history" type="button" role="tab">My History</button>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="mf-leaderboard" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr><th>Rank</th><th>User</th><th>Finished</th><th>Settings</th><th>Score</th></tr>
            </thead>
            <tbody id="mf-leaderboard-body">
              {% for r in leaderboard %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{% if r.user %}{{ r.user.username }}{% else %}Anonymous{% endif %}</td>
                <td>{{ r.finished_at|date:"Y-m-d H:i" }}</td>
                <td>{{ r.settings.operation }} up to {{ r.settings.max_number }}</td>
                <td><strong>{{ r.score }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if not leaderboard %}
          <p id="mf-leaderboard-empty" class="text-muted">No scores yet.</p>
        {% endif %}
      </div>
      <div class="tab-pane fade" id="mf-history" role="tabpanel">
        {% if request.user.is_authenticated %}
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr><th>Finished</th><th>Game</th><th>Settings</th><th>Score</th></tr>
              </thead>
              <tbody id="mf-history-body">
                {% for r in history %}
                <tr>
                  <td>{{ r.finished_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ r.get_game_type_display }}</td>
                  <td>{{ r.settings.operation }} up to {{ r.settings.max_number }}</td>
                  <td><strong>{{ r.score }}</strong></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <button id="mf-history-more" class="btn btn-outline-secondary btn-sm" type="button">Load more</button>
          </div>
          {% if not history %}
            <p id="mf-history-empty" class="text-muted">You have no game history yet.</p>
          {% endif %}
        {% else %}
          <p><a href="{% url 'accounts:login' %}">Log in</a> to see your history.</p>
        {% endif %}
      </div>
    </div>
      </div>
    </div>
  </div>
  {{ block.super }}
{% endblock %}

{% block extra_scripts %}{% endblock %}

<script>
  (function() {
    const isAuth = {{ request.user.is_authenticated|yesno:'true,false' }};
    function fmt(d){ try { return new Date(d).toLocaleString(); } catch(e){ return d; } }

    async function refreshLeaderboard(){
      try {
        const res = await fetch('/api/games/leaderboard/math_facts/');
        const data = await res.json();
        const tbody = document.getElementById('mf-leaderboard-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        data.results.forEach((r, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${r.username}</td><td>${fmt(r.finished_at)}</td><td>${(r.settings||{}).operation || ''} up to ${(r.settings||{}).max_number || ''}</td><td><strong>${r.score}</strong></td>`;
          tbody.appendChild(tr);
        });
        const emptyP = document.getElementById('mf-leaderboard-empty');
        if (emptyP) emptyP.style.display = data.results.length ? 'none' : '';
      } catch(e) { /* ignore */ }
    }

    let historyOffset = 0;
    const historyLimit = 10;
    async function refreshHistory(){
      if (!isAuth) return;
      try {
        const res = await fetch(`/api/games/history/math_facts/?limit=${historyLimit}&offset=0`);
        if (!res.ok) return;
        const data = await res.json();
        const tbody = document.getElementById('mf-history-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        data.results.forEach((r) => {
          const tr = document.createElement('tr');
          const gameLabel = r.game_type === 'math_facts' ? 'Math Facts Practice' : (r.game_type === 'anagram_hunt' ? 'Anagram Hunt' : r.game_type);
          tr.innerHTML = `<td>${fmt(r.finished_at)}</td><td>${gameLabel}</td><td>${(r.settings||{}).operation || ''} up to ${(r.settings||{}).max_number || ''}</td><td><strong>${r.score}</strong></td>`;
          tbody.appendChild(tr);
        });
        const emptyP = document.getElementById('mf-history-empty');
        if (emptyP) emptyP.style.display = data.results.length ? 'none' : '';
        historyOffset = data.results.length;
      } catch(e) { /* ignore */ }
    }

    async function loadMoreHistory(){
      if (!isAuth) return;
      try {
        const res = await fetch(`/api/games/history/math_facts/?limit=${historyLimit}&offset=${historyOffset}`);
        if (!res.ok) return;
        const data = await res.json();
        const tbody = document.getElementById('mf-history-body');
        if (!tbody) return;
        data.results.forEach((r) => {
          const tr = document.createElement('tr');
          const gameLabel = r.game_type === 'math_facts' ? 'Math Facts Practice' : (r.game_type === 'anagram_hunt' ? 'Anagram Hunt' : r.game_type);
          tr.innerHTML = `<td>${fmt(r.finished_at)}</td><td>${gameLabel}</td><td>${(r.settings||{}).operation || ''} up to ${(r.settings||{}).max_number || ''}</td><td><strong>${r.score}</strong></td>`;
          tbody.appendChild(tr);
        });
        historyOffset += data.results.length;
      } catch(e){ /* ignore */ }
    }

    const moreBtn = document.getElementById('mf-history-more');
    if (moreBtn) moreBtn.addEventListener('click', loadMoreHistory);

    // periodic refresh to pick up newly recorded scores
    refreshLeaderboard();
    refreshHistory();
    setInterval(() => { refreshLeaderboard(); refreshHistory(); }, 15000);

    // Intercept XHR POST to results endpoint to refresh immediately on save
    try {
      const OldXHR = window.XMLHttpRequest;
      function NewXHR(){
        const realXhr = new OldXHR();
        const origOpen = realXhr.open;
        realXhr._method = '';
        realXhr._url = '';
        realXhr.open = function(method, url){
          realXhr._method = (method || '').toUpperCase();
          realXhr._url = url || '';
          return origOpen.apply(realXhr, arguments);
        };
        realXhr.addEventListener('loadend', function(){
          if (realXhr._method === 'POST' && realXhr._url.indexOf('/api/games/results/') !== -1 && realXhr.status >= 200 && realXhr.status < 300){
            refreshHistory();
            refreshLeaderboard();
          }
        });
        return realXhr;
      }
      window.XMLHttpRequest = NewXHR;
    } catch(e) { /* ignore */ }
  })();
</script>

<style>
  /* Add a little space between the tabs/heading and the Vue app area */
  #app { margin-top: 12px; }
</style>
